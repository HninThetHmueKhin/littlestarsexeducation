using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using ChildSafeSexEducation.Desktop.Models;
using ChildSafeSexEducation.Desktop.Services;
using Microsoft.Extensions.Configuration;

namespace ChildSafeSexEducation.Desktop
{
    public partial class MainWindow : Window
    {
        private User? _currentUser;
        private List<Topic> _currentTopics = new();
        private List<Question> _currentQuestions = new();
        private int _currentTopicId = 0;
        
        private readonly ContentService _contentService;
        private readonly NLPService _nlpService;
        private readonly LanguageService _languageService;
        private readonly LoggingService _loggingService;
        private readonly UserStorageService _userStorageService;
        private readonly AuthenticationService _authService;

        public MainWindow()
        {
            InitializeComponent();
            _contentService = new ContentService();
            _nlpService = new NLPService(_contentService);
            _languageService = LanguageService.Instance;
            _loggingService = new LoggingService();
            _userStorageService = new UserStorageService();
            _authService = new AuthenticationService();
            
            // Show language selection first
            ShowLanguageSelection();
            
            // Set up daily email sending timer
            SetupDailyEmailTimer();
        }
        
        private void SetupDailyEmailTimer()
        {
            // Set up a timer to send daily emails at 6 PM
            var timer = new System.Windows.Threading.DispatcherTimer();
            timer.Interval = TimeSpan.FromHours(24); // Check every 24 hours
            timer.Tick += async (s, e) => await SendDailyLogs();
            timer.Start();
        }
        
        private async Task SendDailyLogs()
        {
            try
            {
                // Only send daily logs for the currently logged-in user
                if (_currentUser != null && _currentUser.EmailNotificationsEnabled && !string.IsNullOrEmpty(_currentUser.ParentEmail))
                {
                    await _loggingService.SendDailyLogsToAllParentsAsync(new List<User> { _currentUser });
                    Console.WriteLine($"Daily logs sent to parent of {_currentUser.Name}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error sending daily logs: {ex.Message}");
            }
        }
        


        private void TopicsButton_Click(object sender, RoutedEventArgs e)
        {
            if (_currentUser == null) return;
            
            _currentTopics = _contentService.GetTopicsForAge(_currentUser.Age);
            ShowTopicsTab();
            TopicsPopup.Visibility = Visibility.Visible;
        }

        private async void SendDailyLogButton_Click(object sender, RoutedEventArgs e)
        {
            if (_currentUser == null)
            {
                MessageBox.Show("No user logged in.", "Error", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            if (string.IsNullOrWhiteSpace(_currentUser.ParentEmail))
            {
                MessageBox.Show("No parent email address provided.", "Error", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            try
            {
                // Show loading message
                AddMessageToChat(_languageService.GetText("sending_daily_log"), false);
                
                // Send the daily log
                await _loggingService.SendDailyLogToParentAsync(_currentUser);
                
                // Show success message
                AddMessageToChat(_languageService.GetText("daily_log_sent"), false);
                
                MessageBox.Show($"Daily log sent successfully to {_currentUser.ParentEmail}!", 
                              "Success", MessageBoxButton.OK, MessageBoxImage.Information);
            }
            catch (Exception ex)
            {
                // Show error message
                AddMessageToChat(string.Format(_languageService.GetText("daily_log_error"), ex.Message), false);
                
                MessageBox.Show($"Error sending daily log: {ex.Message}", 
                              "Error", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void TestEmailButton_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var emailService = new Services.EmailService();
                var (success, message) = await emailService.SendTestEmailAsync("jennifernovack65@gmail.com");
                
                if (success)
                {
                    MessageBox.Show($"‚úÖ {message}\n\nCheck your inbox (and spam folder) if in real mode.", 
                                  "Test Email Success", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                else
                {
                    MessageBox.Show($"‚ùå Test email failed:\n\n{message}", 
                                  "Test Email Error", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"‚ùå Unexpected error: {ex.Message}\n\nType: {ex.GetType().Name}", 
                              "Test Email Error", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void CloseTopicsButton_Click(object sender, RoutedEventArgs e)
        {
            TopicsPopup.Visibility = Visibility.Collapsed;
        }

        private void TopicsTab_Click(object sender, RoutedEventArgs e)
        {
            ShowTopicsTab();
        }

        private void QuestionsTab_Click(object sender, RoutedEventArgs e)
        {
            ShowQuestionsTab();
        }

        private void BlogsTab_Click(object sender, RoutedEventArgs e)
        {
            ShowBlogsTab();
        }

        private void ShowTopicsTab()
        {
            // Update tab colors
            TopicsTab.Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96));
            QuestionsTab.Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(108, 117, 125));
            BlogsTab.Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(108, 117, 125));
            
            TopicsContent.Children.Clear();
            
            foreach (var topic in _currentTopics)
            {
                var topicCard = new Border
                {
                    Background = System.Windows.Media.Brushes.White,
                    BorderBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(233, 236, 239)),
                    BorderThickness = new Thickness(1),
                    CornerRadius = new CornerRadius(12),
                    Padding = new Thickness(20),
                    Margin = new Thickness(0, 0, 0, 15),
                    Cursor = Cursors.Hand
                };

                var stackPanel = new StackPanel();
                
                var titleText = new TextBlock
                {
                    Text = $"üìö {topic.Title}",
                    FontSize = 18,
                    FontWeight = FontWeights.Bold,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)),
                    Margin = new Thickness(0, 0, 0, 8)
                };
                
                var descText = new TextBlock
                {
                    Text = topic.Description,
                    FontSize = 14,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(108, 117, 125)),
                    TextWrapping = TextWrapping.Wrap,
                    LineHeight = 20
                };
                
                stackPanel.Children.Add(titleText);
                stackPanel.Children.Add(descText);
                topicCard.Child = stackPanel;
                
                topicCard.MouseLeftButtonDown += (s, e) => SelectTopic(topic);
                
                TopicsContent.Children.Add(topicCard);
            }
        }

        private void ShowQuestionsTab()
        {
            // Update tab colors
            TopicsTab.Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(108, 117, 125));
            QuestionsTab.Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96));
            BlogsTab.Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(108, 117, 125));
            
            TopicsContent.Children.Clear();
            
            var allQuestions = new List<Question>();
            foreach (var topic in _currentTopics)
            {
                var questions = _contentService.GetQuestionsForTopic(topic.Id, _currentUser.Age);
                allQuestions.AddRange(questions);
            }
            
            foreach (var question in allQuestions.Take(10)) // Show first 10 questions
            {
                var questionCard = new Border
                {
                    Background = System.Windows.Media.Brushes.White,
                    BorderBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(233, 236, 239)),
                    BorderThickness = new Thickness(1),
                    CornerRadius = new CornerRadius(12),
                    Padding = new Thickness(20),
                    Margin = new Thickness(0, 0, 0, 15),
                    Cursor = Cursors.Hand
                };

                var questionText = new TextBlock
                {
                    Text = $"‚ùì {_languageService.GetText(question.QuestionText)}",
                    FontSize = 16,
                    FontWeight = FontWeights.SemiBold,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)),
                    TextWrapping = TextWrapping.Wrap,
                    LineHeight = 22
                };
                
                questionCard.Child = questionText;
                questionCard.MouseLeftButtonDown += (s, e) => ShowAnswerInChat(question);
                
                TopicsContent.Children.Add(questionCard);
            }
        }

        private void ShowBlogsTab()
        {
            // Update tab colors
            TopicsTab.Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(108, 117, 125));
            QuestionsTab.Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(108, 117, 125));
            BlogsTab.Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96));
            
            TopicsContent.Children.Clear();
            
            var blogs = new[]
            {
                new { Title = "blog_body_awareness", Description = "blog_body_awareness_desc", Category = "category_body_parts", Icon = "üß∏" },
                new { Title = "blog_safety_rules", Description = "blog_safety_rules_desc", Category = "category_personal_safety", Icon = "üõ°Ô∏è" },
                new { Title = "blog_growing_changes", Description = "blog_growing_changes_desc", Category = "category_growing_up", Icon = "üå±" },
                new { Title = "blog_healthy_friendships", Description = "blog_healthy_friendships_desc", Category = "category_healthy_relationships", Icon = "üë´" },
                new { Title = "blog_talking_adults", Description = "blog_talking_adults_desc", Category = "category_personal_safety", Icon = "üë®‚Äçüë©‚Äçüëß‚Äçüë¶" },
                new { Title = "blog_body_boundaries", Description = "blog_body_boundaries_desc", Category = "category_personal_safety", Icon = "üö´" }
            };
            
            foreach (var blog in blogs)
            {
                var blogCard = new Border
                {
                    Background = System.Windows.Media.Brushes.White,
                    BorderBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(233, 236, 239)),
                    BorderThickness = new Thickness(1),
                    CornerRadius = new CornerRadius(12),
                    Padding = new Thickness(20),
                    Margin = new Thickness(0, 0, 0, 15),
                    Cursor = Cursors.Hand
                };

                var stackPanel = new StackPanel();
                
                var headerStack = new StackPanel { Orientation = Orientation.Horizontal };
                
                var iconText = new TextBlock
                {
                    Text = blog.Icon,
                    FontSize = 24,
                    Margin = new Thickness(0, 0, 15, 0),
                    VerticalAlignment = VerticalAlignment.Center
                };
                
                var titleStack = new StackPanel();
                
                var categoryText = new TextBlock
                {
                    Text = _languageService.GetText(blog.Category),
                    FontSize = 12,
                    FontWeight = FontWeights.Bold,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)),
                    Margin = new Thickness(0, 0, 0, 5)
                };
                
                var titleText = new TextBlock
                {
                    Text = _languageService.GetText(blog.Title),
                    FontSize = 16,
                    FontWeight = FontWeights.Bold,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(44, 62, 80)),
                    TextWrapping = TextWrapping.Wrap
                };
                
                titleStack.Children.Add(categoryText);
                titleStack.Children.Add(titleText);
                
                headerStack.Children.Add(iconText);
                headerStack.Children.Add(titleStack);
                
                var descText = new TextBlock
                {
                    Text = _languageService.GetText(blog.Description),
                    FontSize = 14,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(108, 117, 125)),
                    TextWrapping = TextWrapping.Wrap,
                    Margin = new Thickness(0, 10, 0, 0),
                    LineHeight = 18
                };
                
                stackPanel.Children.Add(headerStack);
                stackPanel.Children.Add(descText);
                blogCard.Child = stackPanel;
                
                blogCard.MouseLeftButtonDown += (s, e) => OpenBlogPage(blog.Title, blog.Description, blog.Category);
                
                TopicsContent.Children.Add(blogCard);
            }
        }

        private void BackToChatButton_Click(object sender, RoutedEventArgs e)
        {
            BlogsPanel.Visibility = Visibility.Collapsed;
            MainPanel.Visibility = Visibility.Visible;
        }

        private void ExitButton_Click(object sender, RoutedEventArgs e)
        {
            // Show confirmation dialog
            var result = MessageBox.Show(_languageService.GetText("back_to_start_confirm"), 
                                        _languageService.GetText("back_to_start_title"), 
                                        MessageBoxButton.YesNo, 
                                        MessageBoxImage.Question);
            
            if (result == MessageBoxResult.Yes)
            {
                // Reset user data
                _currentUser = null;
                
                // Clear chat
                ChatPanel.Children.Clear();
                
                // Reset input fields
                
                // Show language selection screen
                ShowLanguageSelection();
            }
        }

        private void SendButton_Click(object sender, RoutedEventArgs e)
        {
            SendMessage();
        }

        private void ChatInput_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter)
            {
                SendMessage();
            }
        }

        private void SendMessage()
        {
            var message = ChatInput.Text.Trim();
            if (string.IsNullOrEmpty(message) || _currentUser == null) return;

            // Add user message
            AddMessageToChat(message, true);
            ChatInput.Text = "";

            // Direct users to click topics instead of typing
            var response = _languageService.GetText("typing_guidance_message");
            AddMessageToChat(response, false);
        }

        private void DisplayTopicsInPopup()
        {
            TopicsContent.Children.Clear();
            
            foreach (var topic in _currentTopics)
            {
                var topicCard = new Border
                {
                    Background = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(248, 249, 250)),
                    BorderBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(233, 236, 239)),
                    BorderThickness = new Thickness(2),
                    CornerRadius = new CornerRadius(10),
                    Padding = new Thickness(15),
                    Margin = new Thickness(0, 0, 0, 10),
                    Cursor = Cursors.Hand
                };

                var stackPanel = new StackPanel();
                
                var titleText = new TextBlock
                {
                    Text = $"üìö {_languageService.GetText(topic.Title)}",
                    FontSize = 16,
                    FontWeight = FontWeights.Bold,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)),
                    Margin = new Thickness(0, 0, 0, 5)
                };
                
                var descText = new TextBlock
                {
                    Text = _languageService.GetText(topic.Description),
                    FontSize = 12,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(108, 117, 125)),
                    TextWrapping = TextWrapping.Wrap
                };
                
                stackPanel.Children.Add(titleText);
                stackPanel.Children.Add(descText);
                topicCard.Child = stackPanel;
                
                topicCard.MouseLeftButtonDown += (s, e) => SelectTopic(topic);
                
                TopicsContent.Children.Add(topicCard);
            }
        }

        private void SelectTopic(Topic topic)
        {
            // Log topic selection activity
            if (_currentUser != null)
            {
                _loggingService.LogActivity(
                    _currentUser,
                    "Topic",
                    topic.Id.ToString(),
                    _languageService.GetText(topic.Title),
                    _languageService.GetText(topic.Description)
                );
            }
            
            // Show questions for this topic in the popup
            ShowQuestionsForTopic(topic);
        }

        private void ShowQuestionsForTopic(Topic topic)
        {
            // Update tab colors to show we're in questions mode
            TopicsTab.Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(108, 117, 125));
            QuestionsTab.Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96));
            BlogsTab.Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(108, 117, 125));
            
            TopicsContent.Children.Clear();
            
            // Add topic header
            var topicHeader = new Border
            {
                Background = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(232, 245, 232)),
                BorderBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)),
                BorderThickness = new Thickness(1),
                CornerRadius = new CornerRadius(8),
                Padding = new Thickness(15),
                Margin = new Thickness(0, 0, 0, 15)
            };

            var headerText = new TextBlock
            {
                Text = $"üìö Questions about {_languageService.GetText(topic.Title)}",
                FontSize = 16,
                FontWeight = FontWeights.Bold,
                Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)),
                HorizontalAlignment = HorizontalAlignment.Center
            };
            
            topicHeader.Child = headerText;
            TopicsContent.Children.Add(topicHeader);
            
            // Add back button
            var backButton = new Button
            {
                Content = "‚Üê Back to All Topics",
                Background = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)),
                Foreground = System.Windows.Media.Brushes.White,
                FontSize = 12,
                FontWeight = FontWeights.SemiBold,
                Padding = new Thickness(15, 8, 15, 8),
                Margin = new Thickness(0, 0, 0, 15),
                HorizontalAlignment = HorizontalAlignment.Center,
                Cursor = Cursors.Hand
            };
            
            backButton.Click += (s, e) => ShowTopicsTab();
            TopicsContent.Children.Add(backButton);
            
            // Show questions for this topic
            var questions = _contentService.GetQuestionsForTopic(topic.Id, _currentUser.Age);
            
            foreach (var question in questions)
            {
                var questionCard = new Border
                {
                    Background = System.Windows.Media.Brushes.White,
                    BorderBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(233, 236, 239)),
                    BorderThickness = new Thickness(1),
                    CornerRadius = new CornerRadius(12),
                    Padding = new Thickness(20),
                    Margin = new Thickness(0, 0, 0, 15),
                    Cursor = Cursors.Hand
                };

                var questionText = new TextBlock
                {
                    Text = $"‚ùì {_languageService.GetText(question.QuestionText)}",
                    FontSize = 16,
                    FontWeight = FontWeights.SemiBold,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)),
                    TextWrapping = TextWrapping.Wrap,
                    LineHeight = 22
                };
                
                questionCard.Child = questionText;
                questionCard.MouseLeftButtonDown += (s, e) => ShowAnswerInChat(question);
                
                TopicsContent.Children.Add(questionCard);
            }
        }

        private void ShowAnswerInChat(Question question)
        {
            // Log question selection activity
            if (_currentUser != null)
            {
                _loggingService.LogActivity(
                    _currentUser,
                    "Question",
                    question.Id.ToString(),
                    _languageService.GetText(question.QuestionText),
                    _languageService.GetText(question.Answer)
                );
            }
            
            TopicsPopup.Visibility = Visibility.Collapsed;
            AddMessageToChat($"Question: {_languageService.GetText(question.QuestionText)}", false);
            AddMessageToChat($"Answer: {_languageService.GetText(question.Answer)}", false);
            
            // Add related blogs
            ShowRelatedBlogs(question);
        }

        private void ShowRelatedBlogs(Question question)
        {
            var relatedBlogs = GetRelatedBlogs(question.QuestionText);
            
            if (relatedBlogs.Any())
            {
                var blogMessage = new Border
                {
                    Background = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(248, 249, 250)),
                    BorderBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(233, 236, 239)),
                    BorderThickness = new Thickness(1),
                    CornerRadius = new CornerRadius(15),
                    Padding = new Thickness(20),
                    Margin = new Thickness(0, 0, 0, 15),
                    HorizontalAlignment = HorizontalAlignment.Left,
                    MaxWidth = 400
                };

                var blogStack = new StackPanel();
                
                var headerText = new TextBlock
                {
                    Text = _languageService.GetText("related_articles"),
                    FontSize = 16,
                    FontWeight = FontWeights.Bold,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)),
                    Margin = new Thickness(0, 0, 0, 15)
                };
                blogStack.Children.Add(headerText);
                
                foreach (var blog in relatedBlogs.Take(3))
                {
                    var blogCard = new Border
                    {
                        Background = System.Windows.Media.Brushes.White,
                        BorderBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(233, 236, 239)),
                        BorderThickness = new Thickness(1),
                        CornerRadius = new CornerRadius(8),
                        Padding = new Thickness(15),
                        Margin = new Thickness(0, 0, 0, 10),
                        Cursor = Cursors.Hand
                    };

                    var cardStack = new StackPanel();
                    
                    var iconTitleStack = new StackPanel { Orientation = Orientation.Horizontal };
                    
                    var iconText = new TextBlock
                    {
                        Text = blog.Item4,
                        FontSize = 20,
                        Margin = new Thickness(0, 0, 10, 0),
                        VerticalAlignment = VerticalAlignment.Center
                    };
                    
                    var titleStack = new StackPanel();
                    
                    var categoryText = new TextBlock
                    {
                        Text = _languageService.GetText(blog.Item3),
                        FontSize = 10,
                        FontWeight = FontWeights.Bold,
                        Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)),
                        Margin = new Thickness(0, 0, 0, 3)
                    };
                    
                    var titleText = new TextBlock
                    {
                        Text = _languageService.GetText(blog.Item1),
                        FontSize = 14,
                        FontWeight = FontWeights.SemiBold,
                        Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(44, 62, 80)),
                        TextWrapping = TextWrapping.Wrap
                    };
                    
                    titleStack.Children.Add(categoryText);
                    titleStack.Children.Add(titleText);
                    
                    iconTitleStack.Children.Add(iconText);
                    iconTitleStack.Children.Add(titleStack);
                    
                    var descText = new TextBlock
                    {
                        Text = _languageService.GetText(blog.Item2),
                        FontSize = 12,
                        Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(108, 117, 125)),
                        TextWrapping = TextWrapping.Wrap,
                        Margin = new Thickness(0, 8, 0, 0),
                        LineHeight = 16
                    };
                    
                    cardStack.Children.Add(iconTitleStack);
                    cardStack.Children.Add(descText);
                    blogCard.Child = cardStack;
                    
                    blogCard.MouseLeftButtonDown += (s, e) => OpenBlogPage(blog.Item1, blog.Item2, blog.Item3);
                    
                    blogStack.Children.Add(blogCard);
                }
                
                var readMoreText = new TextBlock
                {
                    Text = "üí° Click any article to read more!",
                    FontSize = 12,
                    FontStyle = FontStyles.Italic,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(108, 117, 125)),
                    HorizontalAlignment = HorizontalAlignment.Center,
                    Margin = new Thickness(0, 5, 0, 0)
                };
                blogStack.Children.Add(readMoreText);
                
                blogMessage.Child = blogStack;
                ChatPanel.Children.Add(blogMessage);
                
                // Scroll to bottom
                ChatScrollViewer.ScrollToEnd();
            }
        }

        private List<(string Title, string Description, string Category, string Icon)> GetRelatedBlogs(string questionText)
        {
            var allBlogs = new List<(string, string, string, string)>
            {
                ("blog_body_awareness", "blog_body_awareness_desc", "category_body_parts", "üß∏"),
                ("blog_safety_rules", "blog_safety_rules_desc", "category_personal_safety", "üõ°Ô∏è"),
                ("blog_growing_changes", "blog_growing_changes_desc", "category_growing_up", "üå±"),
                ("blog_healthy_friendships", "blog_healthy_friendships_desc", "category_healthy_relationships", "üë´"),
                ("blog_talking_adults", "blog_talking_adults_desc", "category_personal_safety", "üë®‚Äçüë©‚Äçüëß‚Äçüë¶"),
                ("blog_body_boundaries", "blog_body_boundaries_desc", "category_personal_safety", "üö´")
            };
            
            // Simple keyword matching to find related blogs
            var questionLower = questionText.ToLower();
            var relatedBlogs = new List<(string, string, string, string)>();
            
            foreach (var blog in allBlogs)
            {
                var isRelated = false;
                
                // Check for body-related keywords
                if (questionLower.Contains("body") || questionLower.Contains("part") || questionLower.Contains("clean"))
                {
                    if (blog.Item3 == "category_body_parts")
                        isRelated = true;
                }
                
                // Check for safety-related keywords
                if (questionLower.Contains("safe") || questionLower.Contains("boundary") || questionLower.Contains("touch") || questionLower.Contains("private"))
                {
                    if (blog.Item3 == "category_personal_safety")
                        isRelated = true;
                }
                
                // Check for growing up keywords
                if (questionLower.Contains("grow") || questionLower.Contains("change") || questionLower.Contains("older"))
                {
                    if (blog.Item3 == "category_growing_up")
                        isRelated = true;
                }
                
                // Check for relationship keywords
                if (questionLower.Contains("friend") || questionLower.Contains("relationship") || questionLower.Contains("talk"))
                {
                    if (blog.Item3 == "category_healthy_relationships")
                        isRelated = true;
                }
                
                if (isRelated)
                {
                    relatedBlogs.Add(blog);
                }
            }
            
            // If no specific matches, return general safety and body blogs
            if (!relatedBlogs.Any())
            {
                relatedBlogs.Add(allBlogs[0]); // Body Parts
                relatedBlogs.Add(allBlogs[1]); // Personal Safety
            }
            
            return relatedBlogs;
        }

        private void ShowBlogs()
        {
            BlogsPanel.Visibility = Visibility.Visible;
            MainPanel.Visibility = Visibility.Collapsed;
            
            BlogsList.Children.Clear();
            
            var blogs = new[]
            {
                new { Title = "Understanding Your Body", Description = "Learn about body parts and keeping clean", Category = "Body Parts" },
                new { Title = "Staying Safe", Description = "Important safety tips for children", Category = "Personal Safety" },
                new { Title = "Growing Up Changes", Description = "What to expect as you grow older", Category = "Growing Up" },
                new { Title = "Making Good Friends", Description = "How to build healthy friendships", Category = "Healthy Relationships" },
                new { Title = "Talking to Adults", Description = "When and how to ask for help", Category = "Personal Safety" },
                new { Title = "Body Boundaries", Description = "Understanding personal space and privacy", Category = "Personal Safety" }
            };
            
            foreach (var blog in blogs)
            {
                var blogCard = new Border
                {
                    Background = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(248, 249, 250)),
                    BorderBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(233, 236, 239)),
                    BorderThickness = new Thickness(1),
                    CornerRadius = new CornerRadius(8),
                    Padding = new Thickness(15),
                    Margin = new Thickness(0, 0, 0, 10),
                    Cursor = Cursors.Hand,
                    MaxWidth = 300
                };

                var stackPanel = new StackPanel();
                
                var categoryText = new TextBlock
                {
                    Text = blog.Category,
                    FontSize = 10,
                    FontWeight = FontWeights.Bold,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)),
                    Margin = new Thickness(0, 0, 0, 5)
                };
                
                var titleText = new TextBlock
                {
                    Text = blog.Title,
                    FontSize = 14,
                    FontWeight = FontWeights.Bold,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(44, 62, 80)),
                    TextWrapping = TextWrapping.Wrap,
                    Margin = new Thickness(0, 0, 0, 5)
                };
                
                var descText = new TextBlock
                {
                    Text = blog.Description,
                    FontSize = 12,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(108, 117, 125)),
                    TextWrapping = TextWrapping.Wrap
                };
                
                stackPanel.Children.Add(categoryText);
                stackPanel.Children.Add(titleText);
                stackPanel.Children.Add(descText);
                blogCard.Child = stackPanel;
                
                blogCard.MouseLeftButtonDown += (s, e) => OpenBlogPage(blog.Title, blog.Description, blog.Category);
                
                BlogsList.Children.Add(blogCard);
            }
        }

        private void OpenBlogPage(string title, string description, string category)
        {
            // Log blog selection activity
            if (_currentUser != null)
            {
                _loggingService.LogActivity(
                    _currentUser,
                    "Blog",
                    title,
                    _languageService.GetText(title),
                    _languageService.GetText(description)
                );
            }
            
            TopicsPopup.Visibility = Visibility.Collapsed;
            ShowBlogPage(title, description, category);
        }

        private void ShowBlogPage(string title, string description, string category)
        {
            BlogsPanel.Visibility = Visibility.Visible;
            MainPanel.Visibility = Visibility.Collapsed;
            
            BlogsList.Children.Clear();
            
            // Create blog content
            var blogContent = new Border
            {
                Background = System.Windows.Media.Brushes.White,
                BorderBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(233, 236, 239)),
                BorderThickness = new Thickness(1),
                CornerRadius = new CornerRadius(15),
                Padding = new Thickness(30),
                Margin = new Thickness(0, 0, 0, 20)
            };

            var contentStack = new StackPanel();
            
            // Category badge
            var categoryBadge = new Border
            {
                Background = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)),
                CornerRadius = new CornerRadius(15),
                Padding = new Thickness(15, 8, 15, 8),
                HorizontalAlignment = HorizontalAlignment.Left,
                Margin = new Thickness(0, 0, 0, 20)
            };
            
            var categoryText = new TextBlock
            {
                Text = _languageService.GetText(category),
                Foreground = System.Windows.Media.Brushes.White,
                FontSize = 12,
                FontWeight = FontWeights.Bold
            };
            
            categoryBadge.Child = categoryText;
            contentStack.Children.Add(categoryBadge);
            
            // Title
            var titleText = new TextBlock
            {
                Text = _languageService.GetText(title),
                FontSize = 28,
                FontWeight = FontWeights.Bold,
                Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)),
                TextWrapping = TextWrapping.Wrap,
                Margin = new Thickness(0, 0, 0, 20)
            };
            contentStack.Children.Add(titleText);
            
            // Description
            var descText = new TextBlock
            {
                Text = _languageService.GetText(description),
                FontSize = 18,
                Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(44, 62, 80)),
                TextWrapping = TextWrapping.Wrap,
                LineHeight = 28,
                Margin = new Thickness(0, 0, 0, 30)
            };
            contentStack.Children.Add(descText);
            
            // Content sections based on category
            var contentSections = GetBlogContent(category);
            foreach (var section in contentSections)
            {
                var sectionBorder = new Border
                {
                    Background = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(248, 249, 250)),
                    BorderBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(233, 236, 239)),
                    BorderThickness = new Thickness(1),
                    CornerRadius = new CornerRadius(10),
                    Padding = new Thickness(20),
                    Margin = new Thickness(0, 0, 0, 15)
                };
                
                var sectionStack = new StackPanel();
                
                var sectionTitle = new TextBlock
                {
                    Text = _languageService.GetText(section.Title),
                    FontSize = 20,
                    FontWeight = FontWeights.Bold,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)),
                    Margin = new Thickness(0, 0, 0, 10)
                };
                
                var sectionContent = new TextBlock
                {
                    Text = _languageService.GetText(section.Content),
                    FontSize = 16,
                    Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(44, 62, 80)),
                    TextWrapping = TextWrapping.Wrap,
                    LineHeight = 24
                };
                
                sectionStack.Children.Add(sectionTitle);
                sectionStack.Children.Add(sectionContent);
                sectionBorder.Child = sectionStack;
                
                contentStack.Children.Add(sectionBorder);
            }
            
            // Safety reminder
            var reminderBorder = new Border
            {
                Background = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(255, 243, 205)),
                BorderBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(255, 193, 7)),
                BorderThickness = new Thickness(1),
                CornerRadius = new CornerRadius(10),
                Padding = new Thickness(20),
                Margin = new Thickness(0, 20, 0, 0)
            };
            
            var reminderText = new TextBlock
            {
                Text = "üí° Remember: Always talk to a trusted adult (like your parents, teachers, or doctors) if you have any questions or concerns!",
                FontSize = 16,
                FontWeight = FontWeights.SemiBold,
                Foreground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(133, 100, 4)),
                TextWrapping = TextWrapping.Wrap,
                LineHeight = 24
            };
            
            reminderBorder.Child = reminderText;
            contentStack.Children.Add(reminderBorder);
            
            blogContent.Child = contentStack;
            BlogsList.Children.Add(blogContent);
        }

        private List<(string Title, string Content)> GetBlogContent(string category)
        {
            return category switch
            {
                "category_body_parts" => new List<(string, string)>
                {
                    ("blog_body_parts_what", "blog_body_parts_what_content"),
                    ("blog_body_parts_clean", "blog_body_parts_clean_content"),
                    ("blog_body_parts_privacy", "blog_body_parts_privacy_content")
                },
                "category_personal_safety" => new List<(string, string)>
                {
                    ("blog_safety_what", "blog_safety_what_content"),
                    ("blog_safety_touches", "blog_safety_touches_content"),
                    ("blog_safety_saying_no", "blog_safety_saying_no_content")
                },
                "category_growing_up" => new List<(string, string)>
                {
                    ("blog_growing_gradually", "blog_growing_gradually_content"),
                    ("blog_growing_physical", "blog_growing_physical_content"),
                    ("blog_growing_emotional", "blog_growing_emotional_content")
                },
                "category_healthy_relationships" => new List<(string, string)>
                {
                    ("blog_relationships_friends", "blog_relationships_friends_content"),
                    ("blog_relationships_respect", "blog_relationships_respect_content"),
                    ("blog_relationships_communication", "blog_relationships_communication_content")
                },
                _ => new List<(string, string)>
                {
                    ("blog_default_learning", "blog_default_learning_content"),
                    ("blog_default_adults", "blog_default_adults_content"),
                    ("blog_default_feelings", "blog_default_feelings_content")
                }
            };
        }

        private Border AddMessageToChat(string message, bool isUser)
        {
            var messageBorder = new Border
            {
                Background = isUser ? 
                    new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)) :
                    new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(232, 245, 232)),
                BorderBrush = isUser ? 
                    new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(39, 174, 96)) :
                    new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(195, 230, 195)),
                BorderThickness = new Thickness(1),
                CornerRadius = new CornerRadius(15),
                Padding = new Thickness(15),
                Margin = new Thickness(0, 0, 0, 15),
                HorizontalAlignment = isUser ? HorizontalAlignment.Right : HorizontalAlignment.Left,
                MaxWidth = 400
            };

            var messageText = new TextBlock
            {
                Text = message,
                Foreground = isUser ? 
                    System.Windows.Media.Brushes.White :
                    new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(44, 62, 80)),
                TextWrapping = TextWrapping.Wrap,
                FontSize = 14
            };

            messageBorder.Child = messageText;
            ChatPanel.Children.Add(messageBorder);
            
            // Scroll to bottom
            ChatScrollViewer.ScrollToEnd();
            
            return messageBorder;
        }

        private void ShowMainPanel()
        {
            MainPanel.Visibility = Visibility.Visible;
            
            // Update button text with current language
            SendDailyLogButton.Content = _languageService.GetText("send_daily_log");
        }

        private void ShowLanguageSelection()
        {
            LanguagePanel.Visibility = Visibility.Visible;
            MainPanel.Visibility = Visibility.Collapsed;
            TopicsPopup.Visibility = Visibility.Collapsed;
            BlogsPanel.Visibility = Visibility.Collapsed;
        }

        private void EnglishButton_Click(object sender, RoutedEventArgs e)
        {
            _languageService.SetLanguage(Services.Language.English);
            UpdateUIWithCurrentLanguage();
            
            // Force refresh topics if they exist
            if (_currentUser != null && _currentTopics != null && _currentTopics.Count > 0)
            {
                _currentTopics = _contentService.GetTopicsForAge(_currentUser.Age);
                if (TopicsPopup.Visibility == Visibility.Visible)
                {
                    DisplayTopicsInPopup();
                }
            }
        }

        private void BurmeseButton_Click(object sender, RoutedEventArgs e)
        {
            _languageService.SetLanguage(Services.Language.Burmese);
            UpdateUIWithCurrentLanguage();
            
            // Force refresh topics if they exist
            if (_currentUser != null && _currentTopics != null && _currentTopics.Count > 0)
            {
                _currentTopics = _contentService.GetTopicsForAge(_currentUser.Age);
                if (TopicsPopup.Visibility == Visibility.Visible)
                {
                    DisplayTopicsInPopup();
                }
            }
        }

        private void ContinueButton_Click(object sender, RoutedEventArgs e)
        {
            LanguagePanel.Visibility = Visibility.Collapsed;
            LoginPanel.Visibility = Visibility.Visible;
            UpdateUIWithCurrentLanguage();
        }

        // Authentication Event Handlers
        private void LoginButton_Click(object sender, RoutedEventArgs e)
        {
            var usernameOrEmail = LoginUsernameTextBox.Text.Trim();
            var password = LoginPasswordBox.Password;

            if (string.IsNullOrWhiteSpace(usernameOrEmail) || string.IsNullOrWhiteSpace(password))
            {
                MessageBox.Show("Please enter both username/email and password.", "Login Required", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var (success, message) = _authService.Login(usernameOrEmail, password);
            
            if (success)
            {
                _currentUser = _authService.CurrentUser;
                LoginPanel.Visibility = Visibility.Collapsed;
                ShowMainInterface();
                MessageBox.Show(message, "Login Successful", MessageBoxButton.OK, MessageBoxImage.Information);
            }
            else
            {
                MessageBox.Show(message, "Login Failed", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void RegisterButton_Click(object sender, RoutedEventArgs e)
        {
            var username = RegisterUsernameTextBox.Text.Trim();
            var email = RegisterEmailTextBox.Text.Trim();
            var password = RegisterPasswordBox.Password;
            var name = RegisterNameTextBox.Text.Trim();
            var ageItem = RegisterAgeComboBox.SelectedItem as ComboBoxItem;
            var parentName = RegisterParentNameTextBox.Text.Trim();
            var parentEmail = RegisterParentEmailTextBox.Text.Trim();

            if (ageItem?.Tag == null || !int.TryParse(ageItem.Tag.ToString(), out int age))
            {
                MessageBox.Show("Please select a valid age.", "Registration Error", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var (success, message) = _authService.Register(username, email, password, name, age, parentName, parentEmail, _languageService.CurrentLanguage.ToString());

            if (success)
            {
                MessageBox.Show(message, "Registration Successful", MessageBoxButton.OK, MessageBoxImage.Information);
                ShowLoginButton_Click(sender, e); // Switch to login screen
            }
            else
            {
                MessageBox.Show(message, "Registration Failed", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void ShowRegisterButton_Click(object sender, RoutedEventArgs e)
        {
            LoginPanel.Visibility = Visibility.Collapsed;
            RegisterPanel.Visibility = Visibility.Visible;
            UpdateUIWithCurrentLanguage();
        }

        private void ShowLoginButton_Click(object sender, RoutedEventArgs e)
        {
            RegisterPanel.Visibility = Visibility.Collapsed;
            LoginPanel.Visibility = Visibility.Visible;
            UpdateUIWithCurrentLanguage();
        }

        private void ShowMainInterface()
        {
            if (_currentUser == null) return;

            // Update welcome text with user's name
            WelcomeText.Text = $"Hi {_currentUser.Name}! üëã";
            
            // Add welcome message to chat
            AddMessageToChat(_languageService.GetText("welcome_chat_message"), false);
            
            // Show main panel
            LoginPanel.Visibility = Visibility.Collapsed;
            RegisterPanel.Visibility = Visibility.Collapsed;
            MainPanel.Visibility = Visibility.Visible;
            
            // Update button text with current language
            SendDailyLogButton.Content = _languageService.GetText("send_daily_log");
        }

        private void UpdateUIWithCurrentLanguage()
        {
            // Update language selection screen
            LanguageTitle.Text = _languageService.GetText("select_language");
            EnglishButton.Content = _languageService.GetText("language_english");
            BurmeseButton.Content = _languageService.GetText("language_burmese");
            ContinueButton.Content = _languageService.GetText("continue_button");

            // Update login screen
            LoginTitle.Text = _languageService.GetText("login_title");
            LoginUsernameLabel.Text = _languageService.GetText("username_label");
            LoginPasswordLabel.Text = _languageService.GetText("password_label");
            LoginButton.Content = _languageService.GetText("login_button");
            LoginDontHaveAccountText.Text = _languageService.GetText("dont_have_account");
            ShowRegisterButton.Content = _languageService.GetText("register_link");

            // Update register screen
            RegisterTitle.Text = _languageService.GetText("register_title");
            RegisterUsernameLabel.Text = _languageService.GetText("username_label");
            RegisterEmailLabel.Text = _languageService.GetText("email_label");
            RegisterPasswordLabel.Text = _languageService.GetText("password_label");
            RegisterNameLabel.Text = _languageService.GetText("full_name_label");
            RegisterAgeLabel.Text = _languageService.GetText("age_label");
            RegisterParentInfoTitle.Text = _languageService.GetText("parent_info_title");
            RegisterParentNameLabel.Text = _languageService.GetText("parent_name_label");
            RegisterParentEmailLabel.Text = _languageService.GetText("parent_email_label");
            RegisterButton.Content = _languageService.GetText("register_button");
            RegisterAlreadyHaveAccountText.Text = _languageService.GetText("already_have_account");
            ShowLoginButton.Content = _languageService.GetText("login_link");


            // Update main screen
            MainTitle.Text = _languageService.GetText("main_title");
            TopicsButton.Content = _languageService.GetText("topics_button");
            ChatInput.Text = _languageService.GetText("chat_input_placeholder");
            SendButton.Content = _languageService.GetText("send_button");

            // Update topics popup
            TopicsTitle.Text = _languageService.GetText("topics_title");
            TopicsTab.Content = _languageService.GetText("topics_tab");
            QuestionsTab.Content = _languageService.GetText("questions_tab");
            BlogsTab.Content = _languageService.GetText("blogs_tab");
            CloseTopicsButton.Content = _languageService.GetText("close_button");

            // Update age combo box items

            // Refresh topics content if topics popup is visible
            if (TopicsPopup.Visibility == Visibility.Visible)
            {
                // Reload topics for current user's age to get fresh data
                if (_currentUser != null)
                {
                    _currentTopics = _contentService.GetTopicsForAge(_currentUser.Age);
                }
                DisplayTopicsInPopup();
            }
        }

    }
}
